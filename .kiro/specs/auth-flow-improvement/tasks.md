# Tasks: 認証フローの改善 (Auth Flow Improvement)

## Task 1: `OAuthCallbackHandler` の改善（リッチなHTML表示の実装）

**概要:** ブラウザに返却する認証成功/エラー画面を、デザインされたHTML/CSSに変更する。

### Subtasks
- [ ] HTML テンプレートの作成 (design.md の UI Design セクションを参考にする)
    - [ ] 成功時のメッセージと認証コードの表示。
    - [ ] 認証コードのコピーボタンと JavaScript によるコピー機能の実装。
    - [ ] エラー時のメッセージ表示。
- [ ] `OAuthCallbackHandler` 内で、抽出した `code` またはエラーメッセージを HTML テンプレートに埋め込むロジックを実装。
- [ ] `Content-Type: text/html` を正しく設定してレスポンスを返すように修正。

### Verification Steps
- [ ] `OAuthCallbackHandler` を単体で起動、またはテストから呼び出し、返却される HTML に期待した内容（認証コード、コピー用 JS、CSS）が含まれていることを確認する。

---

## Task 2: `AntigravityAuthProvider` のリファクタリング（ハイブリッド待機の実装）

**概要:** ローカルサーバーからの自動受信と標準入力からの手動入力の両方を並行して待機するロジックを実装する。

### Subtasks
- [ ] `login` メソッド内で、自動受信タスク（ローカルサーバー）と手動入力タスクを生成する。
- [ ] `asyncio.wait(..., return_when=asyncio.FIRST_COMPLETED)` 等を使用して、いずれかのタスクが完了するまで待機するロジックを実装。
- [ ] 片方のタスクが完了したら、もう片方のタスクを適切にキャンセルする。
- [ ] 手動入力において、入力された文字列が認証コード単体か、あるいはリダイレクトURL全体かを判別し、適切にパースするロジックを追加。
- [ ] 待機中のメッセージを「認証待機中... (自動で反応しない場合はコードを貼り付けてください)」に変更。
- [ ] タイムアウトおよびエラーハンドリング（サーバー起動失敗時の手動モードへのフォールバックなど）を実装。

### Verification Steps
- [ ] モックを使用して、自動受信が成功した場合に手動入力待ちがキャンセルされることを確認。
- [ ] モックを使用して、手動入力（コード直接入力、URL入力の両方）で認証が完了することを確認。
- [ ] タイムアウト時に適切なエラーメッセージが表示されることを確認。

---

## Task 3: ユニットテストと統合テストの追加

**概要:** 新規ロジックの正当性を担保するためのテストを追加する。

### Subtasks
- [ ] `OAuthCallbackHandler` のテスト: 生成される HTML の内容検証。
- [ ] `AntigravityAuthProvider` のテスト:
    - [ ] 手動入力パースロジックの境界値テスト（空文字、不正なURLなど）。
    - [ ] ハイブリッド待機ロジックのシミュレーション（自動受信優先、手動入力優先の各ケース）。
- [ ] エラーケースのテスト: サーバー起動失敗時の挙動。

### Verification Steps
- [ ] `uv run python -m unittest tests/unit/test_auth.py` (新規作成想定) を実行し、すべてのテストがパスすることを確認。
- [ ] 既存の認証関連テストに影響がないことを確認。
