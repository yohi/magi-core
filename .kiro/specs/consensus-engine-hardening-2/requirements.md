# 要件ドキュメント

## プロジェクト記述（入力）

### 1. 性能 (Performance)

合議プロセスにおけるレイテンシとスループットに関する課題がいくつか特定されました。

  * **課題: デベートフェーズにおけるラウンド実行の直列性によるレイテンシ**

      * **分析**: `src/magi/core/consensus.py` の `_run_debate_phase` メソッドにおいて、ラウンド（`config.debate_rounds`）ごとに `await asyncio.gather` で待ち合わせが発生しています。各ラウンドですべてのエージェントの思考完了を待つ必要があるため、最も遅い応答が全体の律速となります。ラウンド数が増えると、UX上の待機時間が線形に増加します。
      * **改善案**:
          * **ストリーミング処理の導入**: エージェントの思考プロセスをストリーミング（逐次出力）し、ユーザーに進行状況を可視化することで体感レイテンシを下げることが推奨されます。`LLMClient` レベルでのストリーミング対応が必要です。
          * **パイプライン化の検討**: 厳密な同期が不要な場合（例：特定のエージェントが他者の全出力を待つ必要がないケース）、非同期キューを用いたパイプライン処理への移行を検討してください。

  * **課題: リトライロジックにおけるジッター（ゆらぎ）の欠如**

      * **分析**: `src/magi/llm/client.py` の `_retry_with_backoff` メソッドでは、指数バックオフ（`2 ** attempt`）が実装されていますが、ジッター（ランダムな待機時間）が含まれていません。複数のエージェントが同時にレート制限（429エラー）に遭遇した場合、同期して再試行を行い、再度制限に掛かる「サンダーディング・ハード（Thundering Herd）」問題を引き起こすリスクがあります。
      * **改善案**: `wait_time` の計算にランダムな値を加える「Full Jitter」アルゴリズムなどを導入してください。
```python
# 例: Full Jitter
import random
wait_time = random.uniform(0, (2 ** attempt) * base_delay)
```

### 2. 品質 (Quality & Maintainability)

コードの構造と保守性に関して、結合度の高さと設計パターンの適用に改善の余地があります。

  * **課題: 依存性の注入（DI）の欠如とテスト容易性の低下**

      * **分析**: `ConsensusEngine` クラスの `_create_agents` メソッド内で、`LLMClient` を直接インスタンス化しています。
```python
llm_client = LLMClient(...)  # 直接生成
```
      これにより、`ConsensusEngine` と特定の `LLMClient` 実装が密結合しており、ユニットテスト時に `LLMClient` をモック化することが困難になっています（`_create_agents` をモンキーパッチする必要があります）。
      * **改善案**: `LLMClient` のインスタンス（またはファクトリ）を `ConsensusEngine` のコンストラクタ（`__init__`）で受け取るように変更し、依存性の注入（Dependency Injection）パターンを適用してください。これによりテスト時のモック差し替えが容易になります。

  * **課題: レガシーコードの混在による複雑化**

      * **分析**: `_run_voting_phase` メソッド内に、設定フラグ `enable_hardened_consensus` に基づく分岐があり、さらにフェイルセーフとして `_run_voting_phase_legacy` を呼び出すロジックが含まれています。新旧のロジックが混在することでコードの認知負荷が高く、バグの温床になりがちです。
      * **改善案**:
          * **Strategyパターンの適用**: Votingロジックを `VotingStrategy` インターフェースとして切り出し、`HardenedVotingStrategy` と `LegacyVotingStrategy` に分離することを推奨します。
          * **廃止計画**: レガシーパスは将来的に削除することを前提に、`DeprecationWarning` をログ出力するなどして、コードベースのクリーンアップを進めてください。

### 3. セキュリティ (Security)

LLM特有の攻撃手法に対する防御策において、現在の実装では不十分な点があります。

  * **課題: 正規表現ベースのフィルタリングの限界**

      * **分析**: `src/magi/security/filter.py` では `FORBIDDEN_PATTERNS` を用いて「プロンプトインジェクション」や「ジェイルブレイク」を検知しようとしています。しかし、正規表現によるブラックリスト方式は、攻撃者が表現を少し変えるだけ（難読化、多言語化、Base64エンコードの変種など）で容易に回避可能です。
      * **改善案**:
          * **LLMベースの防御（Guardrails）**: 正規表現に加え、入力評価専用のLLM（例: Llama Guard, Nvidia NeMo Guardrails）を用いた意味論的なチェック層を追加することを強く推奨します。
          * **多層防御**: `ignore all previous` のような特定のフレーズだけでなく、プロンプトの構造自体を守るための指示（System Promptの強化）や、出力側の検証も併用してください。

  * **課題: プラグインの署名検証ロジックの不在**

      * **分析**: `src/magi/plugins/loader.py` の `PluginLoader` には `hash` チェックの実装はありますが、デジタル署名（`signature`）を検証するロジックが見当たりません（データクラスにはフィールドが存在しますが、検証コードがありません）。ハッシュ値だけでは、配布元が改ざんされていないこと（完全性）は確認できますが、信頼できる発行元からのものであること（正当性）は保証できません。
      * **改善案**: 公開鍵暗号方式を用いた署名検証プロセスを `load` メソッドまたは `validate` メソッドに追加し、信頼されていないプラグインの読み込みを拒否する仕組みを実装してください。

### まとめ

`MAGI` システムは基礎的な実装がしっかりしていますが、本番運用や大規模な利用を見据えると、特に**コンポーネントの疎結合化（テスト容易性）とセキュリティの多層化**が急務です。上記の提案が、プロジェクトの品質向上に役立つことを願っています。

## 要件
<!-- /kiro:spec-requirements フェーズで生成 -->
