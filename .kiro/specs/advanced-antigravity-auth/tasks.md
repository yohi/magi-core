# Advanced Antigravity Auth 実装タスク一覧

本ドキュメントは、Antigravity 認証システムの高度な機能（フォールバック、自動オンボーディング、メタデータ管理）の実装手順を定義する。

## 変更対象ファイル
- `src/magi/llm/auth/antigravity.py`: メインの実装変更対象

## タスク一覧

### Task 1: 定数定義とヘッダー生成ロジックの更新 (Req 3)
Antigravity API との互換性を維持し、最新のクライアント情報を送信するための定数とヘッダー生成メソッドを実装する。

- [ ] `ANTIGRAVITY_VERSION`, `X_GOOG_API_CLIENT` 等の定数を定義する。
- [ ] `Client-Metadata` 用の JSON 構造を定義する。
- [ ] `_get_headers()` メソッドを実装し、最新の `User-Agent` と `Client-Metadata` を含むディクショナリを返すようにする。

### Task 2: エンドポイント・フォールバック機構の実装 (Req 1)
リクエスト失敗時に異なる環境のエンドポイントを順次試行するロジックを実装する。

- [ ] Daily, Autopush, Prod のエンドポイント URL を定数として定義する。
- [ ] `_fetch_with_fallback(url_suffix, ...)` プライベートメソッドを実装する。
    - [ ] 指定された順序（Daily -> Autopush -> Prod）でリクエストをループ試行する。
    - [ ] 接続エラーまたは 5xx エラーが発生した場合に次のエンドポイントへ移行する。
    - [ ] 全てのエンドポイントが失敗した場合は適切な例外をスローする。

### Task 3: 自動プロジェクト・オンボーディングの実装と統合 (Req 2)
マネージドプロジェクトが存在しない場合に自動的にプロビジョニングを行う機能を実装し、既存フローに統合する。

- [ ] `_onboard_user()` メソッドを実装する。
    - [ ] `onboardUser` エンドポイントを呼び出す。
    - [ ] 最大 10 回のリトライと 5 秒の固定ディレイを伴うループを実装する。
- [ ] `get_project_id`（または相当するプロジェクト ID 取得ロジック）を更新する。
    - [ ] `loadCodeAssist` が失敗、または有効な ID を返さない場合に `_onboard_user()` を呼び出すように変更する。
    - [ ] オンボーディングで取得したプロジェクト ID を設定に反映する。

### Task 4: テストによる動作検証
追加された機能が要件を満たしていることを単体テストで確認する。

- [ ] フォールバックのテスト: 上位エンドポイントの失敗をモックし、下位エンドポイントが呼ばれることを検証する。
- [ ] オンボーディングのテスト: プロジェクト未設定時に `onboardUser` が規定回数試行され、成功後に ID が取得できることを検証する。
- [ ] ヘッダー検証のテスト: 送信されるリクエストヘッダーが期待通りの形式（定数に基づく値）であることを検証する。
- [ ] 全てのテストがパスすることを確認し、LSP 診断でエラーがないことを確認する。
