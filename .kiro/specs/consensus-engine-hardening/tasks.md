# Implementation Plan

- [x] 1. トークン予算管理と要約基盤の強化
- [x] 1.1 階層的要約と重要度圧縮で CONSENSUS_TOKEN_BUDGET を維持する
  - コンテキスト長推定と設定値を共有し、ラウンドごとに超過検知を行う
  - Debate 終了後の結合ログを階層要約し、以降のラウンドでは要約結果を採用する
  - 固定長切り捨てを避け、重要度スコア順で圧縮したコンテキストを保持する
  - 削減理由・フェーズ・ before/after トークン指標を削減ログに記録する
  - _Requirements: 1.1, 1.2, 1.4_

- [x] 1.2 投票フェーズ前のコンテキスト圧縮と削減ログ整備
  - 投票入力のトークン量を推定し、予算超過見込みなら要約/圧縮を適用する
  - 重要度圧縮後のコンテキストと summaryApplied の有無を Voting フローへ引き渡す
  - 削減後のトークン指標と理由を投票フェーズの監査ログへ出力する
  - _Requirements: 1.2, 1.4_

- [x] 2. 構造化出力とテンプレート外部化の実装
- [x] 2.1 投票スキーマに基づくツールベース JSON 出力を強制する
  - VotePayload スキーマを定義し、投票要求をツール呼び出しで強制する
  - LLM 応答を JSON として受け取り、自由形式の文字列からのパースを廃止する
  - スキーマ準拠のペイロードのみを後続の集計へ進める
  - _Requirements: 2.1_

- [x] 2.2 スキーマ検証と再生成リトライ/ログの実装
  - 受信ペイロードを jsonschema で検証し、失敗時は残リトライ回数を管理する
  - CONSENSUS_SUMMARY_RETRY_COUNT 上限到達で CONSENSUS_SCHEMA_RETRY_EXCEEDED を返す
  - WARN/ERROR ログに retry_count と template_version を含めて出力する
  - _Requirements: 2.2_

- [x] 2.3 テンプレートローダーで YAML/JSON/Jinja2 を外部読み込みする
  - name/version/schema_ref/template/variables を持つメタデータを検証する
  - YAML/JSON/Jinja2(+メタデータ) を読み込み、欠落フィールドは検証エラーにする
  - ロード済みテンプレートをスキーマ参照と共に保持し、バリデーションへ渡す
  - _Requirements: 2.3_

- [x] 2.4 テンプレートキャッシュの TTL/ホットリロード/force リロードを行う
  - TTL 失効で自動再読み込みし、versioned キャッシュをアトミックにスワップする
  - 管理 API/CLI からの強制リフレッシュを受け付け、旧版→新版の切替を即時反映する
  - reload の理由・旧新版・TTL を含む INFO ログを出力し、切替時イベントを記録する
  - _Requirements: 2.4, 2.5_

- [x] 2.5 スキーマ/テンプレート不整合の検知と実行可能ログ出力
  - 不整合検知時に影響するテンプレート名とフィールドを抽出しエラー化する
  - ログへテンプレート/スキーマ識別子と不整合フィールドを構造化出力する
  - _Requirements: 2.6_

- [x] 3. クオーラム・リトライ・ストリーミングのフェイルセーフ強化
- [x] 3.1 フェーズ別クオーラム判定とフェイルセーフ遷移を実装する
  - 有効エージェント数とクオーラム閾値を登録し、下回った時点でセッションを中断する
  - クオーラム不足時は投票結果を返さずフェイルセーフ応答を生成する
  - リトライ残数と部分結果フラグを状態として保持し、フェーズ遷移を管理する
  - _Requirements: 3.1, 3.4, 3.6_

- [x] 3.2 エージェント呼び出しのリトライ制御と部分結果保持/除外を行う
  - 個別エージェント失敗を追跡し、設定回数までリトライしながら有効出力を保持する
  - リトライ中にクオーラム未達となったら即時中断し、部分結果は返さずログだけに残す
  - 上限到達で当該エージェントを除外した理由を記録し、クオーラム成立なら集計を返す
  - _Requirements: 3.2, 3.5, 3.6_

- [x] 3.3 CLI ストリーミング出力と再接続リトライを実装する
  - LLM 出力を生成次第ストリーミング送出し、CLI で途切れなく表示する
  - ストリーム断時に MAGI_CLI_STREAM_RETRY_COUNT 回まで再接続または再リクエストを試行する
  - 上限到達時はユーザーに失敗理由を通知し、再接続試行をログへ残す
  - _Requirements: 1.3, 3.3_

- [x] 3.4 クオーラム不足・部分結果の通知とログ出力を整備する
  - フェイルセーフ応答に不足理由、除外エージェント、部分出力有無を明示する
  - 同一情報を内部ログへ構造化記録し、監査で追跡可能にする
  - _Requirements: 3.4, 3.7_

- [x] 4. セキュリティ強化とプラグイン防御
- [x] 4.1 プロンプト埋め込みのマーカー付与と制御シーケンスエスケープを行う
  - データ領域マーカーでユーザー入力境界を囲み、付録Aの正規化手順でエスケープする
  - 改行・ヌルバイト・テンプレート境界・不可視文字を正規化または除去する
  - _Requirements: 4.1_

- [x] 4.2 禁止パターン検出とサニタイズ/拒否の監査ログを出力する
  - ブラックリスト/ホワイトリスト判定で逸脱を検知し、拒否またはサニタイズする
  - 検出パターン識別子を監査ログに残し、入力拒否理由をユーザーへ返す
  - _Requirements: 4.2_

- [x] 4.3 プラグイン引数検証と署名/ハッシュ検証で不正実行を防ぐ
  - 付録Aのホワイトリストと単一引数クォートでメタ文字を検証する
  - 署名/ハッシュが欠落するプラグインを無効化し、WARN ログで理由を通知する
  - _Requirements: 4.3, 4.4_

- [x] 4.4 コンテキスト削減ログの機微制御とサニタイズを適用する
  - LOG_CONTEXT_REDUCTION_KEY に従い詳細ログの出力可否を制御する
  - 制御シーケンスと禁止パターン基準で削減ログをサニタイズした上で出力する
  - _Requirements: 4.5_

- [x] 5. 合議コンポーネント統合とロールアウト
- [x] 5.1 ConsensusEngine への新コンポーネント統合と feature flag 切替を実装する
  - TokenBudgetManager/TemplateLoader/SchemaValidator/QuorumManager/StreamingEmitter をフローに組み込む
  - 既存パスと新パスをフラグで切り替え、フェイルセーフ時は旧挙動にフォールバック可能にする
  - コンテキスト削減・スキーマ検証・クオーラム判定の順序を設計通りに連結する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7, 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 5.2 リロード/フェイルセーフイベントのメトリクス・ログ統合
  - reload/version_changed/context.reduced/schema.retry などのイベントを構造化ログに集約する
  - 部分結果フラグや除外エージェント情報をメトリクスに反映し、監視しやすくする
  - _Requirements: 2.4, 2.5, 2.6, 3.4, 3.7, 4.5_

- [ ] 6. テストと検証
- [ ] 6.1 ユニットテストで要約・検証・サニタイズの分岐を網羅する
  - TokenBudgetManager の要約/圧縮分岐と削減ログ出力をテストする
  - SchemaValidator の正常系/異常系とリトライ上限到達をテストする
  - TemplateLoader の必須フィールド検証と TTL/force リロード分岐をテストする
  - SecurityFilter/PluginGuard のマーカー付与と禁止パターン検出をテストする
  - _Requirements: 1.1, 1.2, 1.4, 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 4.1, 4.2, 4.3, 4.4, 4.5_

- [ ] 6.2 統合テストで合議フローとフェイルセーフ/再接続を検証する
  - スキーマ検証失敗→再試行→上限超過の挙動と WARN/ERROR ログを確認する
  - クオーラム未達/リトライ枯渇時にフェイルセーフ応答へ遷移し部分結果を返さないことを確認する
  - ストリーミング断→再接続→失敗通知までの CLI 表示とログを検証する
  - _Requirements: 1.3, 2.2, 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7_

- [ ] 6.3 負荷・プロパティテストでトークン予算と再接続耐性を評価する
  - 8k→16k 相当のコンテキストで要約後トークン数が閾値以下になることを確認する
  - ランダム生成コンテキストで圧縮後の情報保持率と削減ログの整合性を検証する
  - ストリーム再接続試行回数が設定値を超えないことを計測し、レイテンシを収集する
  - _Requirements: 1.1, 1.2, 1.3, 3.3_
