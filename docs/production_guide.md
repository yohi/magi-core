# 本番運用ガイド

MAGI System を本番環境（Production）で運用するための設定、セキュリティ対策、監視方法について解説します。

## 1. 本番運用モード (Production Mode)

本番運用モードは、システムのセキュリティと信頼性を高めるための動作モードです。
開発環境とは異なり、曖昧な設定やフォールバック動作を禁止し、厳格な構成を強制します。

### 有効化方法

以下のいずれかの方法で設定します。

**環境変数**:
```bash
export MAGI_PRODUCTION_MODE=true
```

**設定ファイル (magi.yaml)**:
```yaml
production_mode: true
```

### 影響と制約

本番運用モードを有効にすると、以下の制約が適用されます：

1.  **公開鍵パスの厳格化**:
    *   `plugin_public_key_path` の明示的な指定が**必須**となります。
    *   カレントディレクトリからの暗黙的な鍵探索は無効化されます。
    *   指定されたパスに有効な鍵ファイルが存在しない場合、システムは起動しません。

2.  **エラーメッセージ**:
    *   設定不備による起動失敗時、セキュリティ上の理由から詳細すぎる内部情報を伏せつつ、修正に必要な情報を提示します。

## 2. プラグイン署名と鍵管理

本番環境では、すべてのプラグインに対して署名検証を推奨（または強制）します。

### 公開鍵パスの設定

本番運用モードでは、信頼できる公開鍵の配置場所を絶対パスで指定することを強く推奨します。

**環境変数**:
```bash
export MAGI_PLUGIN_PUBLIC_KEY_PATH="/etc/magi/keys/plugin_public_key.pem"
```

**設定ファイル**:
```yaml
plugin_public_key_path: "/etc/magi/keys/plugin_public_key.pem"
```

### 鍵の管理ベストプラクティス

*   **アクセス権限**: 鍵ファイルは MAGI プロセスを実行するユーザーのみが読み取れるようにパーミッションを設定してください（例: `chmod 400`）。
*   **ローテーション**: 定期的に鍵ペアを更新し、新しい公開鍵を配備する運用を検討してください。

## 3. 監査ログ (Audit Logs)

MAGI はセキュリティ上重要なイベントを監査ログとして記録します。
これらのログを監視システム（Datadog, CloudWatch Logs, etc.）に転送し、異常検知に役立ててください。

### 重要な監査イベント

| イベントID | 説明 | 重要度 | アクション例 |
|---|---|---|---|
| `plugin.load.started` | プラグインのロード開始 | INFO | 通常の運用監視 |
| `plugin.load.signature_failed` | 署名検証失敗 | **WARN/ERROR** | 不正なプラグインの可能性、即時調査 |
| `plugin.load.timeout` | ロードタイムアウト | WARN | プラグインのパフォーマンス低下、設定見直し |
| `permission.override_denied` | 許可されていないプロンプト変更 | **WARN** | プラグインの権限昇格試行、構成確認 |
| `guardrails.evaluation_failed` | Guardrails による拒否 | INFO/WARN | 入力攻撃の試行、または過剰検知 |

### ログフォーマット

ログは構造化された形式（JSONなど、設定による）で出力されるため、ログ収集基盤でのパースと分析が容易です。
特に `plugin` および `security` タグが付与されたログに注目してください。

## 4. パフォーマンスチューニング

本番環境の負荷に合わせて、以下のパラメータを調整してください。

*   **`MAGI_LLM_CONCURRENCY_LIMIT`**: 同時に実行する LLM リクエスト数。API レート制限に合わせて調整します。
*   **`MAGI_PLUGIN_CONCURRENCY_LIMIT`**: プラグインロード時の並行数。ディスクI/OやCPU負荷を考慮して設定します。
